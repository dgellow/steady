name: CI
permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          cache: true

      - name: Lint code
        run: ./scripts/lint

  test:
    name: Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          cache: true

      - name: Run tests
        run: ./scripts/test

  test-openapi-directory:
    name: OpenAPI Directory Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache submodules
        id: cache-submodules
        uses: actions/cache@v4
        with:
          path: test-fixtures/openapi-directory
          key: submodules-${{ hashFiles('.gitmodules') }}

      - name: Checkout submodules
        if: steps.cache-submodules.outputs.cache-hit != 'true'
        run: git submodule update --init --recursive

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          cache: true

      - name: Run OpenAPI directory tests
        run: deno task test:specs

  test-npm-build:
    name: Test npm Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build npm packages (linux-x64 only)
        run: deno run -A scripts/build_npm.ts --platform linux-x64

      - name: Install and test CLI
        run: |
          cd /tmp
          npm init -y
          npm install ${{ github.workspace }}/npm/cli ${{ github.workspace }}/npm/cli-linux-x64
          npx steady validate ${{ github.workspace }}/tests/specs/simple.yaml
          npx steady --help

  test-sdks:
    name: SDK Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          cache: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run SDK tests
        run: deno task test:sdks --go
